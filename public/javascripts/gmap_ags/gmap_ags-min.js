/*
 * Google Maps Adapter to ArcGIS Server Cache
 * @Author Nianwei Liu [nianwei at gmail.com]
 * @Date 2008-03-27
 */
function LCC(U){if(!U||U==null){U={}}this.name=U.name||"LCC";var D=(U.semi_major||6378137)/(U.unit||0.3048006096012192);var N=U.inverse_flattening||298.257222101;var H=(U.standard_parallel_1||34.33333333333334)*(Math.PI/180);var G=(U.standard_parallel_2||36.16666666666666)*(Math.PI/180);var A=(U.latitude_of_origin||33.75)*(Math.PI/180);var J=(U.central_meridian||-79)*(Math.PI/180);var V=U.false_easting||2000000.002616666;var P=U.false_northing||0;var Q=function(a,b){var Z=Math.sin(a);return Math.cos(a)/Math.sqrt(1-b*Z*Z)};var M=function(a,b){var Z=b*Math.sin(a);return Math.tan(Math.PI/4-a/2)/Math.pow((1-Z)/(1+Z),b/2)};var O=function(Z,c,b,d){return Z*c*Math.pow(b,d)};var E=function(Z,c,b){var a=c*Math.sin(b);return Math.PI/2-2*Math.atan(Z*Math.pow((1-a)/(1+a),c/2))};var T=function(b,d,f){var a=0;var c=f;var Z=E(b,d,c);while(Math.abs(Z-c)>1e-9&&a<10){a++;c=Z;Z=E(b,d,c)}return Z};var B=1/N;var F=2*B-B*B;var C=Math.sqrt(F);var L=Q(H,F);var K=Q(G,F);var I=M(A,C);var Y=M(H,C);var W=M(G,C);var X=Math.log(L/K)/Math.log(Y/W);var R=L/(X*Math.pow(Y,X));var S=O(D,R,I,X);this.forward=function(g){var d=g[1]*(Math.PI/180);var Z=g[0]*(Math.PI/180);var b=M(d,C);var c=O(D,R,b,X);var a=X*(Z-J);var e=V+c*Math.sin(a);var f=P+S-c*Math.cos(a);return[e,f]};this.inverse=function(f){var e=f[0];var g=f[1];var b=Math.atan((e-V)/(S-(g-P)));var a=(X>0?1:-1)*Math.sqrt((e-V)*(e-V)+(S-(g-P))*(S-(g-P)));var c=Math.pow((a/(D*R)),1/X);var d=T(c,C,0);var Z=b/X+J;return[Z*(180/Math.PI),d*(180/Math.PI)]};this.circum=function(){return Math.PI*2*D}}function TMERC(B){if(!B||B==null){B={}}this.name=B.name||"TMERC";var K=(B.semi_major||6378137)/(B.unit||0.3048006096012192);var M=B.inverse_flattening||298.257222101;var C=B.scale_factor||0.9999;var I=(B.latitude_of_origin||30)*(Math.PI/180);var J=(B.central_meridian||-84.16666666666667)*(Math.PI/180);var A=B.false_easting||2296583.333333333;var O=B.false_northing||0;var G=1/M;var F=2*G-G*G;var H=Math.sqrt(F);var P=F*F;var N=P*F;var D=F/(1-F);var E=function(R,Q,U,T,S){return Q*((1-U/4-3*T/64-5*S/256)*R-(3*U/8+3*T/32+45*S/1024)*Math.sin(2*R)+(15*T/256+45*S/1024)*Math.sin(4*R)-(35*S/3072)*Math.sin(6*R))};var L=E(I,K,F,P,N);this.forward=function(R){var W=R[1]*(Math.PI/180);var Z=R[0]*(Math.PI/180);var V=K/Math.sqrt(1-F*Math.pow(Math.sin(W),2));var U=Math.pow(Math.tan(W),2);var Q=D*Math.pow(Math.cos(W),2);var S=(Z-J)*Math.cos(W);var X=E(W,K,F,P,N);var Y=A+C*V*(S+(1-U+Q)*Math.pow(S,3)/6+(5-18*U+U*U+72*Q-58*D)*Math.pow(S,5)/120);var V=O+C*(X-L)+V*Math.tan(W)*(S*S/2+(5-U+9*Q+4*Q*Q)*Math.pow(S,4)/120+(61-58*U+U*U+600*Q-330*D)*Math.pow(S,6)/720);return[Y,V]};this.inverse=function(c){var d=c[0];var V=c[1];var Y=(1-Math.sqrt(1-F))/(1+Math.sqrt(1-F));var R=L+(V-O)/C;var a=R/(K*(1-F/4-3*P/64-5*N/256));var Z=a+(3*Y/2-27*Math.pow(Y,3)/32)*Math.sin(2*a)+(21*Y*Y/16-55*Math.pow(Y,4)/32)*Math.sin(4*a)+(151*Math.pow(Y,3)/6)*Math.sin(6*a)+(1097*Math.pow(Y,4)/512)*Math.sin(8*a);var T=D*Math.pow(Math.cos(Z),2);var W=Math.pow(Math.tan(Z),2);var X=K/Math.sqrt(1-F*Math.pow(Math.sin(Z),2));var S=K*(1-F)/Math.pow((1-F*Math.pow(Math.sin(Z),2)),3/2);var Q=(d-A)/(X*C);var U=Z-(X*Math.tan(Z)/S)*(Q*Q/2-(5+3*W+10*T-4*T*T-9*D)*Math.pow(Q,4)/24+(61+90*W+28*T+45*W*W-252*D-3*T*T)*Math.pow(Q,6)/720);var b=J+(Q-(1+2*W+T)*Math.pow(Q,3)/6+(5-2*T+28*W-3*T*T+8*D+24*W*W)*Math.pow(Q,5)/120)/Math.cos(Z);return[b*(180/Math.PI),U*(180/Math.PI)]};this.circum=function(){return Math.PI*2*K}}function GCS(A){if(!A||A==null){A={}}this.name=A.name||"GCS";this.circum=function(){return 360};this.forward=function(B){return B};this.inverse=function(B){return B}}function GMapCacheProjection(A){if(!A||A==null){A={}}this.zoomOffset=A.zoomOffset||10;this.originX=A.originX||0;this.originY=A.originY||2000000;this.projection=A.projection||new LCC();this.resolutions=A.resolutions||[434.027777777778,217.013888888889,108.506944444444,55.5555555555556,27.7777777777778,13.8888888888889,6.94444444444444,3.47222222222222,1.73611111111111,1,0.5];this.bounds=A.bounds||null}GMapCacheProjection.prototype=new GProjection();GMapCacheProjection.prototype.fromLatLngToPixel=function(F,B){if(F==null){return null}var D=this.projection.forward([F.lng(),F.lat()]);var C=B-this.zoomOffset;var A=Math.round((D[0]-this.originX)/this.resolutions[C]);var E=Math.round((this.originY-D[1])/this.resolutions[C]);return new GPoint(A,E)};GMapCacheProjection.prototype.fromPixelToLatLng=function(B,C,E){if(B==null){return null}var D=C-this.zoomOffset;var A=B.x*this.resolutions[D]+this.originX;var G=this.originY-B.y*this.resolutions[D];var F=this.projection.inverse([A,G]);return new GLatLng(F[1],F[0])};GMapCacheProjection.prototype.tileCheckRange=function(G,I,F){var H=this.bounds;if(!H||H==null){return true}var E=I-this.zoomOffset;var D=G.x*F*this.resolutions[E]+this.originX;var C=this.originY-(G.y+1)*F*this.resolutions[E];var B=(G.x+1)*F*this.resolutions[E]+this.originX;var A=this.originY-G.y*F*this.resolutions[E];return !(H.minX>B||H.maxX<D||H.maxY<C||H.minY>A)};GMapCacheProjection.prototype.getWrapWidth=function(A){var B=A-this.zoomOffset;return this.projection.circum()/this.resolutions[B]};GMapCacheProjection.prototype.fromLatLngToCoords=function(B){var A=this.projection.forward([B.lng(),B.lat()]);return new GPoint(A[0],A[1])};GMapCacheProjection.prototype.fromCoordsToLatLng=function(A){var B=this.projection.inverse([A.x,A.y]);return new GLatLng(B[1],B[0])};function GMapCacheAdapter(C,E,B){if(!B||B==null){B={}}var D=function(J,H,G){var I=J.indexOf(H);if(I==-1){return""}if(H==""){I=0}var K=J.indexOf(G,I+H.length);if(K==-1||G==""){K=J.length-1}return J.substring(I+H.length,K)};var F=function(H,G){return H.getElementsByTagName(G)[0].firstChild.nodeValue};var A=function(I){var J={};var H=D(I,'PROJECTION["','"]');var G=D(I,"SPHEROID[","]").split(",");if(H!=""){J.unit=parseFloat(D(D(I,"PROJECTION",""),"UNIT[","]").split(",")[1]);J.semi_major=parseFloat(G[1]);J.inverse_flattening=parseFloat(G[2]);J.latitude_of_origin=parseFloat(D(I,'"Latitude_Of_Origin",',"]"));J.central_meridian=parseFloat(D(I,'"Central_Meridian",',"]"));J.false_easting=parseFloat(D(I,'"False_Easting",',"]"));J.false_northing=parseFloat(D(I,'"False_Northing",',"]"))}switch(H){case"":return new GCS(J);case"Lambert_Conformal_Conic":J.standard_parallel_1=parseFloat(D(I,'"Standard_Parallel_1",',"]"));J.standard_parallel_2=parseFloat(D(I,'"Standard_Parallel_2",',"]"));return new LCC(J);case"Transverse_Mercator":J.scale_factor=parseFloat(extracString(I,'"Scale_Factor",',"]"));return new TMERC(J);default:throw H+"  not implemented yet"}};GDownloadUrl(C,function(H,S){if(S==200){var P=GXml.parse(H);var O=F(P,"WKT");var G=A(O);var J={};J.projection=G;J.originX=parseFloat(F(P,"X"));J.originY=parseFloat(F(P,"Y"));var Q=[];var I=P.getElementsByTagName("LODInfo");for(var L=0;L<I.length;L++){Q.push(F(I[L],"Resolution"))}J.resolutions=Q;J.zoomOffset=Math.floor(Math.log(G.circum()/Q[0]/256)/Math.LN2+0.5);if(B&&B.bounds){J.bounds=B.bounds}var K=new GMapCacheProjection(J);var V=parseInt(F(P,"TileCols"));var R=F(P,"CacheTileFormat");switch(R){case"JPEG":case"JPG":R="jpg";break;case"PNG8":case"PNG24":case"PNG32":R="png";break}var N=B.baseUrl||C.substring(0,C.lastIndexOf("/"))+"/_allLayers";var M=B.name||D(D(C,"/",""),"/","/");var U=new GTileLayer(B.copyright||"",J.zoomOffset,(J.zoomOffset+J.resolutions.length-1),B);U.getTileUrl=function(Y,X){var W=N+"/L"+("00"+(X-J.zoomOffset).toString(10)).substring(("00"+(X-J.zoomOffset).toString(10)).length-2)+"/R"+("00000000"+Y.y.toString(16)).substring(("00000000"+Y.y.toString(16)).length-8)+"/C"+("00000000"+Y.x.toString(16)).substring(("00000000"+Y.x.toString(16)).length-8)+"."+R;return W};B.tileSize=V;var T=new GMapType([U],K,M,B);E.addMapType(T);E.setMapType(T)}})}function MapOverlay(A,B){this.url=A;this.bounds=B}MapOverlay.prototype=new GOverlay();MapOverlay.prototype.initialize=function(B){var A=document.createElement("img");A.style.position="absolute";B.getPane(G_MAP_MAP_PANE).appendChild(A);this.map_=B;this.img_=A};MapOverlay.prototype.remove=function(){this.img_.parentNode.removeChild(this.img_)};MapOverlay.prototype.copy=function(){return new MapOverlay(this.url)};MapOverlay.prototype.redraw=function(C){if(!C){return }var A=this.bounds.getSouthWest();var E=this.bounds.getNorthEast();var D=this.map_.fromLatLngToDivPixel(A);var B=this.map_.fromLatLngToDivPixel(E);this.img_.src=this.url;this.img_.style.left=D.x+"px";this.img_.style.top=B.y+"px";this.img_.style.width=Math.abs(B.x-D.x)+"px";this.img_.style.height=Math.abs(D.y-B.y)+"px"};